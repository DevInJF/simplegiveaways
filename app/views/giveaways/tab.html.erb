<div id="fb-root"></div>

<div id="enter_giveaway">
  <a href="#">Enter Giveaway</a>
</div>
<div id="giveaway_image">
  <%= image_tag @giveaway.image.url %>
</div>

<div id="giveaway_modal" style="display:none">
  <div class="step one">
    <span>To be eligible for the giveaway, please like this page first.</span>
    <fb:like-box href="<%= @giveaway.facebook_page.url %>" width="402" show_faces="true" border_color=""
                 stream="false"
    header="false"></fb:like-box>
  </div>
  <div class="step two" style="display:none">
    <a href="#">Click Here to Enter the Giveaway</a>
  </div>
  <div class="step three" style="display:none">
    <span>Congratulations!</span>
    <span>You have successfully entered the giveaway.</span>
  </div>
  <div class="loader" style="display:none">
    <%= image_tag "ajax-loader.gif", :alt => "Loading..." %>
  </div>
</div>

<%= javascript_include_tag "http://connect.facebook.net/en_US/all.js" %>
<script type="text/javascript">
  window.fbAsyncInit = function() {
    FB.init({
      appId  : '<%= FB_APP_ID %>',
      status : true, // check login status
      cookie : true, // enable cookies to allow the server to access the session
      xfbml  : true, // parse XFBML
      channelUrl  : 'http://simplegiveawayapp.com/channel.html'
    });
    FB.Canvas.setSize();
    FB.Event.subscribe('edge.create', function() {
      $just_liked = true;
      Giveaway.step.one.hide();
      Giveaway.step.two.show();
    });
  };

  (function() {
    var e = document.createElement('script');
    e.src = document.location.protocol + '//connect.facebook.net/en_US/all.js';
    e.async = true;
    document.getElementById('fb-root').appendChild(e);
  }());

  $(function(){

    // init
    $just_liked = false;

    var $modal = $("#giveaway_modal");
    var $loader = $modal.find(".loader");

    $("#giveaway_image").click(function(){
      Giveaway.modal.hide();
    });

    // Giveaway object
    Giveaway = {

      modal : $modal,

      step : {
        one : $modal.find(".step.one"),
        two : $modal.find(".step.two"),
        three : $modal.find(".step.three")
      },

      loader : $loader,

      eligible : <%= @has_liked %>,

      entry : {

        loader : function() {
          $modal.find(".step").hide();
          $loader.show();
          $modal.show();
        },

        error : function(error) {
          $loader.hide();
          Giveaway.step.two.hide();
          Giveaway.step.three.show().html('<p>' + error + '</p>');
        },

        submit : function(thesession, json) {
          Giveaway.entry.loader();
          if (json) {
            thesession = eval('(' + thesession + ')'); //decode json
          }
          $.ajax({
            type: 'POST',
            url: '<%= giveaway_entries_path(@giveaway) %>',
            dataType: "text",
            data: 'session_key=' + thesession.session_key + '&has_liked=' + Giveaway.eligible,
            statusCode: {
              200: function() {
                Giveaway.step.two.hide();
                Giveaway.step.three.show();
              },
              406: function() {
                Giveaway.entry.error("You have already entered the giveaway.<br />Entry is limited to one per person.");
              },
              404: function() {
                Giveaway.entry.error("There was an unexpected error.<br />Please reload the page and try again.");
              },
              424: function() {
                Giveaway.entry.error("There was an unexpected error.<br />Please reload the page and try again.");
              }
            }
          });
        },

        statusCheck : function() {
          FB.getLoginStatus(function(response) {
            if (response.session) {
              Giveaway.entry.submit(response.session);
            } else {
              FB.ui({
                method: 'oauth',
                client_id: '<%= FB_APP_ID %>',
                perms: 'email, user_location, user_birthday, user_likes, publish_stream, offline_access'
              },
              function(response) {
                if (response.session) {
                  Giveaway.entry.submit(response.session);
                } else {
                  Giveaway.entry.error("You must grant permissions in order to enter the giveaway.");
                }
              });
            }
          });
        },

        eligible : function() {
          Giveaway.entry.loader();
          Giveaway.entry.statusCheck();
        }
      }
    };

    // Event Listeners
    $("#enter_giveaway a").click(function(e) {
      if (Giveaway.eligible || $just_liked) {
        Giveaway.entry.eligible();
      } else {
        Giveaway.modal.show();
        Giveaway.step.two.find("a").click(function(event){
          event.preventDefault();
          Giveaway.entry.statusCheck();
        });
      }
      e.preventDefault();
    });
  });
</script>